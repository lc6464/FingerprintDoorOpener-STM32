/**
 * @file FPM383C_Example.cpp
 * @brief FPM383C æŒ‡çº¹è¯†åˆ«æ¨¡å—ä½¿ç”¨ç¤ºä¾‹
 * @details å±•ç¤ºå¦‚ä½•ä½¿ç”¨é‡æ„åçš„ FPM383C ç±»
 */

#include "FPM383C.h"
#include "main.h"
#include <cstdio>

// å‡è®¾å·²ç»åˆå§‹åŒ–äº† UART å’Œ GPIO
extern UART_HandleTypeDef huart1;

// å®šä¹‰å¼•è„š
static PortPinPair touchPin(TOUCH_GPIO_Port, TOUCH_Pin);
static PortPinPair powerPin(POWER_GPIO_Port, POWER_Pin);

// åˆ›å»º FPM383C å®ä¾‹
static FPM383C fingerprint(&huart1, touchPin, &powerPin);

/**
 * @brief ç¤ºä¾‹1ï¼šåŸºæœ¬åˆå§‹åŒ–å’Œæµ‹è¯•
 */
void Example_BasicInitialization() {
    printf("=== FPM383C åŸºæœ¬åˆå§‹åŒ–ç¤ºä¾‹ ===\n");

    auto status = fingerprint.Init();
    if (status == FPM383C::Status::OK) {
        printf("âœ“ æ¨¡å—åˆå§‹åŒ–æˆåŠŸ\n");
    } else {
        printf("âœ— æ¨¡å—åˆå§‹åŒ–å¤±è´¥ï¼Œé”™è¯¯ç : %d\n", static_cast<int>(status));
        return;
    }

    // è·å–å·²æ³¨å†ŒæŒ‡çº¹æ•°é‡
    uint16_t count = 0;
    status = fingerprint.GetFingerprintCount(count);
    if (status == FPM383C::Status::OK) {
        printf("âœ“ å½“å‰å·²æ³¨å†ŒæŒ‡çº¹æ•°é‡: %d\n", count);
    } else {
        printf("âœ— è·å–æŒ‡çº¹æ•°é‡å¤±è´¥\n");
    }
}

/**
 * @brief ç¤ºä¾‹2ï¼šåŒæ­¥æŒ‡çº¹åŒ¹é…
 */
void Example_SyncMatch() {
    printf("\n=== åŒæ­¥æŒ‡çº¹åŒ¹é…ç¤ºä¾‹ ===\n");
    printf("è¯·å°†æ‰‹æŒ‡æ”¾åœ¨ä¼ æ„Ÿå™¨ä¸Š...\n");

    // ç­‰å¾…æ‰‹æŒ‡æŒ‰ä¸‹
    bool isPressed = false;
    while (!isPressed) {
        fingerprint.IsFingerPressed(isPressed);
        HAL_Delay(100);
    }

    printf("âœ“ æ£€æµ‹åˆ°æ‰‹æŒ‡ï¼Œå¼€å§‹åŒ¹é…...\n");

    // è¿›è¡ŒåŒ¹é…
    FPM383C::MatchResult result;
    auto status = fingerprint.Match(result);

    if (status == FPM383C::Status::OK) {
        if (result.IsSuccess) {
            printf("âœ“ åŒ¹é…æˆåŠŸï¼\n");
            printf("  - æŒ‡çº¹ ID: %d\n", result.FingerId);
            printf("  - åŒ¹é…åˆ†æ•°: %d\n", result.MatchScore);
        } else {
            printf("âœ— åŒ¹é…å¤±è´¥ï¼Œæœªæ‰¾åˆ°åŒ¹é…çš„æŒ‡çº¹\n");
        }
    } else {
        printf("âœ— åŒ¹é…æ“ä½œå¤±è´¥ï¼Œé”™è¯¯ç : %d\n", static_cast<int>(status));
    }
}

/**
 * @brief ç¤ºä¾‹3ï¼šåŒæ­¥æŒ‡çº¹æ³¨å†Œï¼ˆå¸¦è¿›åº¦å›è°ƒï¼‰
 */
void Example_SyncEnroll() {
    printf("\n=== åŒæ­¥æŒ‡çº¹æ³¨å†Œç¤ºä¾‹ ===\n");

    const uint16_t fingerId = 0xFFFF;  // è‡ªåŠ¨åˆ†é… ID
    const uint8_t requiredPresses = 6;  // éœ€è¦æŒ‰å‹ 6 æ¬¡

    printf("å¼€å§‹æ³¨å†Œæ–°æŒ‡çº¹ï¼Œéœ€è¦æŒ‰å‹ %d æ¬¡\n", requiredPresses);

    FPM383C::EnrollStatus finalStatus;

    // å¸¦è¿›åº¦å›è°ƒçš„æ³¨å†Œ
    auto status = fingerprint.AutoEnroll(
        fingerId,
        requiredPresses,
        finalStatus,
        [](const FPM383C::EnrollStatus &status) {
            // è¿›åº¦å›è°ƒ
            if (!status.IsComplete) {
                printf("  è¿›åº¦: %d%% (æ­¥éª¤ %d/%d)\n",
                    status.Progress, status.Step, 6);
            }
        }
    );

    if (status == FPM383C::Status::OK && finalStatus.IsComplete) {
        printf("âœ“ æ³¨å†ŒæˆåŠŸï¼\n");
        printf("  - åˆ†é…çš„æŒ‡çº¹ ID: %d\n", finalStatus.FingerId);
    } else {
        printf("âœ— æ³¨å†Œå¤±è´¥ï¼Œé”™è¯¯ç : %d\n", static_cast<int>(status));
    }
}

/**
 * @brief ç¤ºä¾‹4ï¼šä½¿ç”¨å¼‚æ­¥å›è°ƒï¼ˆæ¨èæ–¹å¼ï¼‰
 */
void Example_AsyncCallbacks() {
    printf("\n=== å¼‚æ­¥å›è°ƒç¤ºä¾‹ ===\n");

    // æ³¨å†ŒåŒ¹é…æˆåŠŸå›è°ƒ
    fingerprint.RegisterMatchCallback([](const FPM383C::MatchResult &result) {
        if (result.IsSuccess) {
            printf("ğŸ‰ å¼‚æ­¥åŒ¹é…æˆåŠŸï¼\n");
            printf("  - æŒ‡çº¹ ID: %d\n", result.FingerId);
            printf("  - åŒ¹é…åˆ†æ•°: %d\n", result.MatchScore);

            // åœ¨è¿™é‡Œå¯ä»¥è§¦å‘å¼€é—¨ç­‰æ“ä½œ
            // HAL_GPIO_WritePin(DOOR_LOCK_GPIO_Port, DOOR_LOCK_Pin, GPIO_PIN_SET);
        } else {
            printf("âŒ å¼‚æ­¥åŒ¹é…å¤±è´¥\n");
        }
    });

    // æ³¨å†Œæ³¨å†Œè¿›åº¦å›è°ƒ
    fingerprint.RegisterEnrollProgressCallback([](const FPM383C::EnrollStatus &status) {
        printf("ğŸ“Š æ³¨å†Œè¿›åº¦: %d%% (æ­¥éª¤ %d)\n", status.Progress, status.Step);
    });

    // æ³¨å†Œæ³¨å†Œå®Œæˆå›è°ƒ
    fingerprint.RegisterEnrollCompleteCallback([](const FPM383C::EnrollStatus &status) {
        printf("âœ… æ³¨å†Œå®Œæˆï¼æŒ‡çº¹ ID: %d\n", status.FingerId);
    });

    printf("âœ“ å›è°ƒå‡½æ•°å·²æ³¨å†Œ\n");
    printf("æç¤º: è°ƒç”¨ StartAsyncMatch() æˆ– StartAsyncEnroll() å¼€å§‹å¼‚æ­¥æ“ä½œ\n");

    // TODO: å®ç°å¼‚æ­¥æ“ä½œ
    // fingerprint.StartAsyncMatch();
    // fingerprint.StartAsyncEnroll();
}

/**
 * @brief ç¤ºä¾‹5ï¼šåˆ é™¤æŒ‡çº¹
 */
void Example_DeleteFingerprint() {
    printf("\n=== åˆ é™¤æŒ‡çº¹ç¤ºä¾‹ ===\n");

    // åˆ é™¤æŒ‡å®š ID çš„æŒ‡çº¹
    const uint16_t fingerId = 1;
    auto status = fingerprint.DeleteFingerprint(fingerId);

    if (status == FPM383C::Status::OK) {
        printf("âœ“ æˆåŠŸåˆ é™¤æŒ‡çº¹ ID: %d\n", fingerId);
    } else {
        printf("âœ— åˆ é™¤å¤±è´¥ï¼Œé”™è¯¯ç : %d\n", static_cast<int>(status));
    }

    // åˆ é™¤æ‰€æœ‰æŒ‡çº¹ï¼ˆè°¨æ…ä½¿ç”¨ï¼ï¼‰
    // status = fingerprint.DeleteAllFingerprints();
    // if (status == FPM383C::Status::OK) {
    //     printf("âœ“ æˆåŠŸåˆ é™¤æ‰€æœ‰æŒ‡çº¹\n");
    // }
}

/**
 * @brief ç¤ºä¾‹6ï¼šè®¾ç½®å¯†ç 
 */
void Example_SetPassword() {
    printf("\n=== è®¾ç½®å¯†ç ç¤ºä¾‹ ===\n");

    const uint32_t newPassword = 0x12345678;
    auto status = fingerprint.SetPassword(newPassword, true);  // true = ä¿å­˜åˆ° Flash

    if (status == FPM383C::Status::OK) {
        printf("âœ“ å¯†ç è®¾ç½®æˆåŠŸ\n");
        printf("  æ–°å¯†ç : 0x%08X\n", newPassword);
    } else {
        printf("âœ— å¯†ç è®¾ç½®å¤±è´¥ï¼Œé”™è¯¯ç : %d\n", static_cast<int>(status));
    }
}

/**
 * @brief ç¤ºä¾‹7ï¼šé”™è¯¯å¤„ç†
 */
void Example_ErrorHandling() {
    printf("\n=== é”™è¯¯å¤„ç†ç¤ºä¾‹ ===\n");

    FPM383C::MatchResult result;
    auto status = fingerprint.Match(result);

    // è¯¦ç»†çš„é”™è¯¯å¤„ç†
    switch (status) {
        case FPM383C::Status::OK:
            printf("âœ“ æ“ä½œæˆåŠŸ\n");
            if (result.IsSuccess) {
                printf("  åŒ¹é…åˆ°æŒ‡çº¹ ID: %d\n", result.FingerId);
            } else {
                printf("  æœªåŒ¹é…åˆ°æŒ‡çº¹\n");
            }
            break;

        case FPM383C::Status::Timeout:
            printf("âœ— æ“ä½œè¶…æ—¶ï¼Œè¯·æ£€æŸ¥æ¨¡å—è¿æ¥\n");
            break;

        case FPM383C::Status::TransmitError:
            printf("âœ— å‘é€é”™è¯¯ï¼Œè¯·æ£€æŸ¥ UART é…ç½®\n");
            break;

        case FPM383C::Status::ReceiveError:
            printf("âœ— æ¥æ”¶é”™è¯¯ï¼Œè¯·æ£€æŸ¥ UART é…ç½®\n");
            break;

        case FPM383C::Status::InvalidResponse:
            printf("âœ— æ— æ•ˆå“åº”ï¼Œæ•°æ®åŒ…æŸåæˆ–æ ¡éªŒå¤±è´¥\n");
            break;

        case FPM383C::Status::ModuleError:
            printf("âœ— æ¨¡å—å†…éƒ¨é”™è¯¯\n");
            break;

        case FPM383C::Status::Busy:
            printf("âœ— æ¨¡å—å¿™ï¼Œè¯·ç¨åé‡è¯•\n");
            break;

        default:
            printf("âœ— æœªçŸ¥é”™è¯¯\n");
            break;
    }
}

/**
 * @brief UART æ¥æ”¶å®Œæˆå›è°ƒï¼ˆéœ€è¦åœ¨ stm32f1xx_it.c ä¸­è°ƒç”¨ï¼‰
 */
extern "C" void HAL_UARTEx_RxEventCallback(UART_HandleTypeDef *huart, uint16_t Size) {
    if (huart == &huart1) {
        fingerprint.UartRxCallback(Size);
    }
}

/**
 * @brief ä¸»å‡½æ•°ä¸­è°ƒç”¨æ‰€æœ‰ç¤ºä¾‹
 */
void RunAllExamples() {
    printf("\n");
    printf("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\n");
    printf("â•‘   FPM383C æŒ‡çº¹è¯†åˆ«æ¨¡å—ä½¿ç”¨ç¤ºä¾‹      â•‘\n");
    printf("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n");
    printf("\n");

    Example_BasicInitialization();
    HAL_Delay(1000);

    Example_AsyncCallbacks();
    HAL_Delay(1000);

    Example_ErrorHandling();
    HAL_Delay(1000);

    // äº¤äº’å¼ç¤ºä¾‹ï¼ˆéœ€è¦ç”¨æˆ·æ“ä½œï¼‰
    // Example_SyncMatch();
    // Example_SyncEnroll();
    // Example_DeleteFingerprint();
    // Example_SetPassword();

    printf("\n");
    printf("âœ“ æ‰€æœ‰ç¤ºä¾‹è¿è¡Œå®Œæˆï¼\n");
    printf("\n");
}
